import Foundation

@main
struct SwiftMCPRegistryTool {
    static func main() throws {
        let args = CommandLine.arguments
        guard args.count >= 3 else {
            fputs("Usage: SwiftMCPRegistryTool <target-name> <output-file> [source-files...]\n", stderr)
            exit(2)
        }

        let targetName = args[1]
        let outputPath = args[2]
        let sourceFiles = Array(args.dropFirst(3))

        let markerTools = sourceFiles.filter { file in
            (try? String(contentsOfFile: file, encoding: .utf8).contains("@MCPTool")) == true
        }.count

        let generated = """
        // AUTO-GENERATED by SwiftMCPRegistryTool. DO NOT EDIT.
        import Foundation

        public enum __SwiftMCPRegistryPluginGenerated {
            public static let target = \"\(targetName)\"
            public static let toolAnnotationFileCount = \(markerTools)
        }
        """

        let outputURL = URL(fileURLWithPath: outputPath)
        try FileManager.default.createDirectory(at: outputURL.deletingLastPathComponent(), withIntermediateDirectories: true)
        try generated.write(to: outputURL, atomically: true, encoding: .utf8)
    }
}
